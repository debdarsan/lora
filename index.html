<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Anxiety Helper - AI-Powered</title>
    
    <!-- Material Design Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6200EA;
            --primary-dark: #3700B3;
            --primary-light: #BB86FC;
            --secondary: #03DAC6;
            --secondary-dark: #018786;
            --background: #FAFAFA;
            --surface: #FFFFFF;
            --error: #CF6679;
            --warning: #FF9800;
            --success: #4CAF50;
            --on-primary: #FFFFFF;
            --on-surface: #000000;
            --on-background: #000000;
            --shadow-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-2: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            --shadow-3: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
            --shadow-4: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--background);
            min-height: 100vh;
            color: var(--on-background);
        }

        .app-bar {
            background: var(--primary);
            color: var(--on-primary);
            padding: 16px 24px;
            box-shadow: var(--shadow-2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .app-bar h1 {
            font-size: 24px;
            font-weight: 400;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-bar p {
            font-size: 14px;
            opacity: 0.87;
            margin-top: 4px;
            margin-left: 36px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Disclaimer and Crisis Resources */
        .disclaimer-card {
            background: #FFF3E0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid var(--warning);
            box-shadow: var(--shadow-1);
        }

        .disclaimer-card h4 {
            color: #E65100;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .disclaimer-card p {
            font-size: 14px;
            line-height: 1.5;
            color: rgba(0,0,0,0.87);
        }

        .crisis-card {
            background: #FFEBEE;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid var(--error);
            box-shadow: var(--shadow-1);
        }

        .crisis-card h4 {
            color: #C62828;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .crisis-card ul {
            list-style: none;
            padding: 0;
        }

        .crisis-card li {
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .crisis-card a {
            color: #C62828;
            font-weight: 500;
            text-decoration: none;
        }

        .crisis-card a:hover {
            text-decoration: underline;
        }

        .tab-container {
            background: var(--surface);
            border-radius: 8px;
            box-shadow: var(--shadow-1);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .tabs {
            display: flex;
            background: var(--primary);
            box-shadow: var(--shadow-1);
        }

        .tab {
            flex: 1;
            padding: 16px 24px;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: var(--on-primary);
            opacity: 0.7;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1.25px;
            position: relative;
        }

        .tab:hover {
            opacity: 0.9;
        }

        .tab.active {
            opacity: 1;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--secondary);
        }

        .tab-content {
            display: none;
            padding: 24px;
            animation: fadeIn 0.3s;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--surface);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-1);
        }

        .card-title {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 16px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .material-icons {
            font-size: 24px;
        }

        .fab {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: var(--on-primary);
            font-size: 48px;
            cursor: pointer;
            box-shadow: var(--shadow-3);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 32px auto;
        }

        .fab:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-4);
        }

        .fab.listening {
            animation: pulse 1.5s infinite;
            background: var(--secondary-dark);
        }

        .fab:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(3, 218, 198, 0.7); }
            70% { box-shadow: 0 0 0 30px rgba(3, 218, 198, 0); }
            100% { box-shadow: 0 0 0 0 rgba(3, 218, 198, 0); }
        }

        .btn {
            background: var(--primary);
            color: var(--on-primary);
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1.25px;
            cursor: pointer;
            box-shadow: var(--shadow-1);
            transition: all 0.3s;
            margin: 4px;
        }

        .btn:hover {
            box-shadow: var(--shadow-2);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--on-surface);
        }

        .btn-text {
            background: transparent;
            color: var(--primary);
            box-shadow: none;
        }

        .btn-text:hover {
            background: rgba(98, 0, 234, 0.08);
            box-shadow: none;
        }

        .btn-danger {
            background: var(--error);
        }

        .text-field {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(0, 0, 0, 0.12);
            border-radius: 4px;
            font-size: 16px;
            font-family: 'Roboto', sans-serif;
            transition: all 0.3s;
            background: var(--surface);
            margin: 8px 0;
        }

        .text-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 1px var(--primary);
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin: 16px 0;
            cursor: pointer;
        }

        .checkbox-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }

        .select-field {
            padding: 12px 16px;
            border: 1px solid rgba(0, 0, 0, 0.12);
            border-radius: 4px;
            font-size: 16px;
            font-family: 'Roboto', sans-serif;
            background: var(--surface);
            cursor: pointer;
            transition: all 0.3s;
            margin: 8px 0;
        }

        .select-field:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Severity Slider */
        .severity-section {
            margin: 24px 0;
            padding: 16px;
            background: #F5F5F5;
            border-radius: 8px;
        }

        .severity-section h4 {
            margin-bottom: 16px;
            color: var(--primary);
        }

        .severity-slider {
            width: 100%;
            margin: 16px 0;
        }

        .severity-value {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin: 8px 0;
        }

        .severity-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: rgba(0,0,0,0.54);
        }

        .transcript {
            margin: 24px 0;
            padding: 16px;
            background: #F5F5F5;
            border-radius: 8px;
            min-height: 64px;
            border-left: 4px solid var(--primary);
        }

        /* Follow-up Section */
        .followup-card {
            background: #E8F5E9;
            border-radius: 8px;
            padding: 20px;
            margin: 24px 0;
            border-left: 4px solid var(--success);
            box-shadow: var(--shadow-1);
            display: none;
        }

        .followup-card h4 {
            color: #2E7D32;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .followup-card p {
            font-size: 16px;
            line-height: 1.6;
            color: rgba(0,0,0,0.87);
        }

        .result-card {
            background: var(--surface);
            border-radius: 8px;
            padding: 24px;
            margin: 24px 0;
            box-shadow: var(--shadow-2);
            border-left: 4px solid var(--primary);
        }

        .chip {
            display: inline-block;
            padding: 4px 12px;
            background: var(--primary-light);
            color: var(--on-primary);
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            margin: 4px;
        }

        .chip-success {
            background: var(--secondary);
            color: var(--on-surface);
        }

        .chip-warning {
            background: var(--warning);
            color: var(--on-primary);
        }

        .progress-bar {
            height: 8px;
            background: #E0E0E0;
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--error), #FFC107, var(--secondary));
            transition: width 0.5s ease;
        }

        .prevention-box {
            background: linear-gradient(135deg, #F3E5F5, #FFFFFF);
            padding: 24px;
            border-radius: 8px;
            margin-top: 16px;
            border-left: 4px solid var(--primary);
        }

        .ai-badge {
            background: var(--primary);
            color: var(--on-primary);
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
            display: inline-block;
        }

        .history-item {
            background: var(--surface);
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
            box-shadow: var(--shadow-1);
            transition: all 0.3s;
        }

        .history-item:hover {
            box-shadow: var(--shadow-2);
        }

        .severity-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }

        .severity-low { background: #C8E6C9; color: #2E7D32; }
        .severity-medium { background: #FFF3E0; color: #EF6C00; }
        .severity-high { background: #FFCDD2; color: #C62828; }

        /* Rate Limit Warning */
        .rate-limit-warning {
            background: #FFF3E0;
            color: #E65100;
            padding: 12px;
            border-radius: 4px;
            margin: 12px 0;
            font-size: 14px;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .status-bar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: var(--shadow-3);
            z-index: 1000;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100%); }
            to { transform: translateX(-50%) translateY(0); }
        }

        .status-success {
            background: var(--secondary);
            color: var(--on-surface);
        }

        .status-error {
            background: var(--error);
            color: var(--on-primary);
        }

        .status-info {
            background: var(--primary);
            color: var(--on-primary);
        }

        .status-warning {
            background: var(--warning);
            color: var(--on-primary);
        }

        .divider {
            height: 1px;
            background: rgba(0, 0, 0, 0.12);
            margin: 24px 0;
        }

        .settings-section {
            margin-bottom: 32px;
        }

        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 16px 0;
        }

        .settings-label {
            font-size: 16px;
            color: rgba(0, 0, 0, 0.87);
        }

        .api-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .api-status.connected {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .api-status.disconnected {
            background: #FFEBEE;
            color: #C62828;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-1);
        }

        th {
            background: var(--primary);
            color: var(--on-primary);
            padding: 16px;
            text-align: left;
            font-weight: 500;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.12);
        }

        tr:hover {
            background: #F5F5F5;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: rgba(0, 0, 0, 0.54);
        }

        .empty-state i {
            font-size: 72px;
            color: rgba(0, 0, 0, 0.26);
            margin-bottom: 16px;
        }

        .voice-status {
            text-align: center;
            margin: 16px 0;
            color: rgba(0, 0, 0, 0.54);
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .tabs {
                overflow-x: auto;
            }
            
            .tab {
                padding: 12px 16px;
                font-size: 12px;
            }

            .crisis-card {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="app-bar">
        <h1>
            <i class="material-icons">psychology</i>
            Anxiety Helper
        </h1>
        <p>AI-Powered Symptom Analysis & Personalized Support</p>
    </div>

    <div class="container">
        <!-- Disclaimer -->
        <div class="disclaimer-card">
            <h4>
                <i class="material-icons">warning</i>
                Important Disclaimer
            </h4>
            <p>This tool is for informational purposes only and is not a substitute for professional medical advice, diagnosis, or treatment. Always seek the advice of your physician or qualified mental health provider with any questions you may have regarding your condition.</p>
        </div>

        <!-- Crisis Resources -->
        <div class="crisis-card">
            <h4>
                <i class="material-icons">emergency</i>
                Crisis Resources
            </h4>
            <ul>
                <li><strong>National Suicide Prevention Lifeline:</strong> <a href="tel:988">988</a> or <a href="tel:1-800-273-8255">1-800-273-8255</a></li>
                <li><strong>Crisis Text Line:</strong> Text HOME to <a href="sms:741741">741741</a></li>
                <li><strong>International Crisis Lines:</strong> <a href="https://findahelpline.com" target="_blank">findahelpline.com</a></li>
                <li><strong>Emergency:</strong> Call 911 or your local emergency number</li>
            </ul>
        </div>

        <div class="tab-container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab(event, 'voice')">
                    <i class="material-icons">mic</i> Voice
                </button>
                <button class="tab" onclick="switchTab(event, 'history')">
                    <i class="material-icons">history</i> History
                </button>
                <button class="tab" onclick="switchTab(event, 'database')">
                    <i class="material-icons">storage</i> Database
                </button>
                <button class="tab" onclick="switchTab(event, 'settings')">
                    <i class="material-icons">settings</i> Settings
                </button>
            </div>

            <div id="voice" class="tab-content active">
                <div id="apiWarning" class="card" style="background: #FFF3E0; border-left: 4px solid #FF9800; display: none;">
                    <div class="card-title" style="color: #E65100;">
                        <i class="material-icons">warning</i>
                        API Key Required
                    </div>
                    <p style="color: rgba(0,0,0,0.87);">Please configure your OpenAI API key in Settings to use AI-powered symptom matching.</p>
                    <button class="btn" onclick="switchTab(event, 'settings')" style="margin-top: 16px;">
                        Go to Settings
                    </button>
                </div>

                <div id="permissionCard" class="card" style="background: #E3F2FD; display: none;">
                    <div class="card-title" style="color: #1565C0;">
                        <i class="material-icons">mic_none</i>
                        Enable Microphone Access
                    </div>
                    <p>This app needs microphone access to hear your symptoms and provide personalized support.</p>
                    <button class="btn" onclick="requestPermissions()" style="margin-top: 16px;">
                        <i class="material-icons">check</i>
                        Grant Access
                    </button>
                </div>

                <div id="rateLimitWarning" class="rate-limit-warning">
                    <i class="material-icons">schedule</i>
                    <span>Rate limit active. Please wait <span id="rateLimitSeconds">2</span> seconds before making another request.</span>
                </div>

                <button class="fab" id="micButton" onclick="startRecording()">
                    <i class="material-icons" id="micIcon">mic</i>
                </button>
                
                <p class="voice-status" id="status">Click the microphone to describe your symptoms</p>

                <div class="transcript" id="transcript">
                    <p style="color: rgba(0,0,0,0.54);">Your spoken symptoms will appear here...</p>
                </div>

                <!-- Severity Slider -->
                <div class="severity-section">
                    <h4>How severe are your symptoms? (1-10)</h4>
                    <input type="range" class="severity-slider" id="severitySlider" min="1" max="10" value="5" oninput="updateSeverity()">
                    <div class="severity-value" id="severityValue">5</div>
                    <div class="severity-labels">
                        <span>Mild</span>
                        <span>Moderate</span>
                        <span>Severe</span>
                    </div>
                </div>

                <!-- Follow-up Card -->
                <div id="followupCard" class="followup-card">
                    <h4>
                        <i class="material-icons">chat</i>
                        Let's clarify
                    </h4>
                    <p id="followupText"></p>
                </div>

                <div id="resultSection" class="result-card" style="display: none;">
                    <h3 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="material-icons" style="color: var(--primary);">analytics</i>
                        Analysis Results
                        <span id="matchIndicator" class="chip" style="display: none;">AI Match</span>
                    </h3>
                    
                    <div style="margin: 16px 0;">
                        <strong>Matched Symptoms:</strong>
                        <div id="matchedSymptom" style="margin: 8px 0 16px 0;"></div>
                    </div>
                    
                    <div style="margin: 16px 0;">
                        <strong>Confidence Score:</strong>
                        <span id="confidenceScore" style="margin-left: 8px; font-weight: 500; color: var(--primary);"></span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="confidenceFill"></div>
                        </div>
                    </div>

                    <div style="margin: 16px 0;">
                        <strong>Severity Level:</strong>
                        <span id="severityBadge" class="severity-badge"></span>
                    </div>
                    
                    <div id="aiReasoning" style="display: none; margin: 16px 0; padding: 12px; background: #F5F5F5; border-radius: 4px; border-left: 3px solid var(--primary);">
                        <strong>AI Analysis:</strong>
                        <p id="reasoningText" style="margin-top: 8px; color: rgba(0,0,0,0.87);"></p>
                    </div>
                    
                    <div style="margin: 16px 0;">
                        <strong>NLP Conflict Patterns:</strong>
                        <div id="nlpConflict" style="margin: 8px 0; font-style: italic; color: rgba(0,0,0,0.67);"></div>
                    </div>
                    
                    <div class="divider"></div>
                    
                    <div style="margin-top: 24px;">
                        <strong style="display: block; margin-bottom: 16px;">Prevention & Support Plan:</strong>
                        <div id="preventionText"></div>
                    </div>
                </div>
            </div>

            <div id="history" class="tab-content">
                <div class="card">
                    <div class="card-title">
                        <i class="material-icons">history</i>
                        Your History
                    </div>
                    <div id="historyList"></div>
                    <button class="btn btn-danger" onclick="clearHistory()" style="margin-top: 16px;">
                        <i class="material-icons">delete</i>
                        Clear All History
                    </button>
                </div>
            </div>

            <div id="database" class="tab-content">
                <div class="card">
                    <div class="card-title">
                        <i class="material-icons">storage</i>
                        Symptom Database
                    </div>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Symptom</th>
                                    <th>Prevention</th>
                                    <th>NLP Conflict</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="databaseBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="settings" class="tab-content">
                <div class="card">
                    <div class="card-title">
                        <i class="material-icons">vpn_key</i>
                        API Configuration
                    </div>
                    <p style="color: rgba(0,0,0,0.67); margin-bottom: 16px;">
                        Your OpenAI API key is required for AI-powered symptom matching and personalized prevention plans. 
                        The key is stored locally in your browser and never sent to any server except OpenAI.
                    </p>
                    
                    <input type="password" id="apiKey" class="text-field" placeholder="sk-..." />
                    
                    <div style="margin: 16px 0; display: flex; gap: 8px; align-items: center;">
                        <button class="btn" onclick="saveApiKey()">Save Key</button>
                        <button class="btn btn-secondary" onclick="testApiKey()">Test Connection</button>
                        <button class="btn btn-text" onclick="clearApiKey()">Clear</button>
                        <span id="apiStatus" class="api-status disconnected">
                            <i class="material-icons" style="font-size: 16px;">cloud_off</i>
                            Not Connected
                        </span>
                    </div>
                    
                    <p style="font-size: 12px; color: rgba(0,0,0,0.54); margin-top: 16px;">
                        Get your API key from: <a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--primary);">OpenAI Platform</a>
                    </p>
                    <p style="font-size: 12px; color: rgba(0,0,0,0.54); margin-top: 8px;">
                        Model: gpt-3.5-turbo-0125 (Optimized for cost and speed)
                    </p>
                </div>

                <div class="card">
                    <div class="card-title">
                        <i class="material-icons">tune</i>
                        Matching Configuration
                    </div>
                    
                    <div class="settings-row">
                        <span class="settings-label">Number of symptoms to match:</span>
                        <select id="numMatches" class="select-field" onchange="saveSettings()" style="width: auto;">
                            <option value="1">1 symptom</option>
                            <option value="2">2 symptoms</option>
                            <option value="3" selected>3 symptoms</option>
                            <option value="4">4 symptoms</option>
                            <option value="5">5 symptoms</option>
                        </select>
                    </div>
                    
                    <div class="settings-row">
                        <span class="settings-label">Minimum confidence threshold:</span>
                        <select id="minConfidence" class="select-field" onchange="saveSettings()" style="width: auto;">
                            <option value="20">20%</option>
                            <option value="30" selected>30%</option>
                            <option value="40">40%</option>
                            <option value="50">50%</option>
                        </select>
                    </div>
                    
                    <div class="checkbox-container">
                        <input type="checkbox" id="consolidatePreventions" checked onchange="saveSettings()">
                        <label for="consolidatePreventions">
                            Use AI to create personalized, empathetic prevention plans
                        </label>
                    </div>
                    
                    <div id="consolidationStatus" style="padding: 12px; border-radius: 4px; margin-top: 16px; background: #E8F5E9;">
                        <span id="consolidationText" style="color: #2E7D32; font-size: 14px;">
                            <i class="material-icons" style="font-size: 16px; vertical-align: middle;">check_circle</i>
                            AI consolidation enabled
                        </span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <i class="material-icons">import_export</i>
                        Data Management
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="exportHistory()">
                            <i class="material-icons">download</i>
                            Export History
                        </button>
                        <button class="btn btn-text" onclick="importHistory()">
                            <i class="material-icons">upload</i>
                            Import History
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <i class="material-icons">privacy_tip</i>
                        Privacy & Security
                    </div>
                    <ul style="color: rgba(0,0,0,0.67); line-height: 1.8; list-style: none; padding: 0;">
                        <li>✓ Your API key is stored locally in your browser</li>
                        <li>✓ Voice data is processed by your browser's speech recognition</li>
                        <li>✓ OpenAI API calls are made directly from your browser</li>
                        <li>✓ No data is stored on any external server</li>
                        <li>✓ All processing happens on your device</li>
                    </ul>
                </div>

                <div class="card">
                    <div class="card-title">
                        <i class="material-icons">info</i>
                        About
                    </div>
                    <p style="color: rgba(0,0,0,0.67); line-height: 1.6;">
                        Version 2.1 - Enhanced with improved AI matching, severity tracking, follow-up questions, rate limiting, and crisis resources.<br><br>
                        This tool uses GPT-3.5-turbo-0125 to provide intelligent symptom matching and personalized support for anxiety management.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="statusMessage" style="display: none;"></div>

    <script>
        // Comprehensive anxiety symptom database
        const anxietyDatabase = [
            {
                symptom: "Racing heart or palpitations",
                keywords: ["heart", "racing", "palpitations", "heartbeat", "pulse", "chest", "pounding", "fast heart", "rapid heartbeat"],
                prevention: "Practice deep breathing exercises: Inhale for 4 counts, hold for 4, exhale for 6. Repeat 5-10 times. Consider regular cardio exercise to improve heart rate variability.",
                nlpConflict: "Physical sensations vs. safety beliefs"
            },
            {
                symptom: "Difficulty breathing or shortness of breath",
                keywords: ["breathing", "breath", "breathless", "air", "suffocating", "can't breathe", "shortness", "gasping", "hyperventilating", "tight chest"],
                prevention: "Use the 5-4-3-2-1 grounding technique: Name 5 things you see, 4 you can touch, 3 you hear, 2 you smell, 1 you taste. Practice diaphragmatic breathing daily.",
                nlpConflict: "Control vs. surrender patterns"
            },
            {
                symptom: "Excessive worry about the future",
                keywords: ["worry", "future", "anxious", "concerned", "overthinking", "what if", "scared", "tomorrow", "next week"],
                prevention: "Set a 'worry window' - dedicate 15 minutes daily to process worries, then redirect thoughts. Practice mindfulness meditation focusing on present moment awareness.",
                nlpConflict: "Future projection vs. present reality"
            },
            {
                symptom: "Feeling overwhelmed or out of control",
                keywords: ["overwhelmed", "control", "too much", "can't handle", "stressed", "pressure", "chaos", "losing it"],
                prevention: "Break tasks into smaller steps. Create a priority matrix: urgent/important quadrants. Practice the STOP technique: Stop, Take a breath, Observe, Proceed mindfully.",
                nlpConflict: "All-or-nothing thinking patterns"
            },
            {
                symptom: "Trouble sleeping or insomnia",
                keywords: ["sleep", "insomnia", "can't sleep", "awake", "tired", "restless nights", "tossing turning"],
                prevention: "Establish a wind-down routine 1 hour before bed. No screens, practice progressive muscle relaxation. Keep a worry journal beside your bed to offload thoughts.",
                nlpConflict: "Active mind vs. rest needs"
            },
            {
                symptom: "Muscle tension or body aches",
                keywords: ["tension", "muscle", "tight", "ache", "pain", "stiff", "sore", "shoulders", "neck", "back"],
                prevention: "Practice progressive muscle relaxation: Tense and release each muscle group for 5 seconds. Consider yoga or gentle stretching. Take magnesium supplements after consulting a doctor.",
                nlpConflict: "Holding vs. releasing patterns"
            },
            {
                symptom: "Difficulty concentrating or mind going blank",
                keywords: ["concentrate", "focus", "blank", "mind", "distracted", "foggy", "can't think", "forget"],
                prevention: "Use the Pomodoro Technique: 25 minutes focus, 5 minute break. Practice single-tasking. Try brain-training exercises or puzzles to improve cognitive flexibility.",
                nlpConflict: "Mental overload vs. clarity needs"
            },
            {
                symptom: "Irritability or restlessness",
                keywords: ["irritable", "angry", "restless", "agitated", "annoyed", "frustrated", "on edge", "snappy", "fidgety"],
                prevention: "Engage in physical activity to release tension. Practice self-compassion exercises. Set clear boundaries and communicate needs assertively.",
                nlpConflict: "Internal pressure vs. external demands"
            },
            {
                symptom: "Avoiding social situations",
                keywords: ["avoiding", "social", "isolation", "alone", "withdraw", "hide", "people", "crowds", "parties"],
                prevention: "Start with small, manageable social goals. Practice self-compassion. Prepare conversation starters. Use the 3-3-3 rule: name 3 things you see, hear, and can move.",
                nlpConflict: "Safety vs. connection needs"
            },
            {
                symptom: "Panic attacks or sudden fear",
                keywords: ["panic", "attack", "fear", "terror", "dying", "losing control", "sudden", "intense", "scared"],
                prevention: "Learn to recognize early warning signs. Practice TIPP: Temperature change, Intense exercise, Paced breathing, Paired muscle relaxation. Create a panic attack action plan.",
                nlpConflict: "Fight-or-flight vs. actual threat"
            },
            {
                symptom: "Constant fatigue or exhaustion",
                keywords: ["tired", "fatigue", "exhausted", "no energy", "drained", "worn out", "weak", "sleepy", "lethargic"],
                prevention: "Maintain consistent sleep schedule. Limit caffeine intake. Practice energy management: match activities to energy levels. Consider vitamin D and B12 levels check.",
                nlpConflict: "Hypervigilance vs. rest requirements"
            },
            {
                symptom: "Digestive issues or stomach problems",
                keywords: ["stomach", "digestive", "nausea", "sick", "belly", "gut", "bathroom", "upset stomach", "butterflies"],
                prevention: "Practice mindful eating. Reduce caffeine and alcohol. Try gut-friendly foods: probiotics, fiber. Consider the gut-brain connection through vagus nerve exercises.",
                nlpConflict: "Gut feelings vs. mental processing"
            },
            {
                symptom: "Sweating or trembling",
                keywords: ["sweating", "sweat", "trembling", "shaking", "tremor", "hot", "cold", "clammy", "shivering"],
                prevention: "Keep cooling aids handy. Practice acceptance of physical symptoms. Use positive self-talk. Consider beta-blockers for performance anxiety (consult doctor).",
                nlpConflict: "Visibility fears vs. authenticity"
            },
            {
                symptom: "Fear of losing control or going crazy",
                keywords: ["crazy", "losing mind", "going mad", "insane", "losing it", "breakdown", "snap", "psychotic", "unreal"],
                prevention: "Remind yourself: anxiety is uncomfortable but not dangerous. Practice reality testing. Keep a symptom diary to identify patterns. Seek professional support.",
                nlpConflict: "Catastrophic thinking vs. reality"
            },
            {
                symptom: "Perfectionism or fear of making mistakes",
                keywords: ["perfect", "mistakes", "failure", "wrong", "not good enough", "mess up", "disappoint", "standards"],
                prevention: "Set 'good enough' standards. Practice deliberate imperfection. Celebrate small wins. Use the 80/20 rule: 80% perfect is often sufficient.",
                nlpConflict: "Ideal self vs. human self"
            }
        ];

        let recognition = null;
        let isRecording = false;
        let synthesis = window.speechSynthesis;
        let hasPermissions = false;
        let apiKey = '';
        let lastAPICall = 0;
        const API_COOLDOWN = 2000; // 2 seconds
        let settings = {
            numMatches: 3,
            minConfidence: 30,
            consolidatePreventions: true
        };

        // Update severity display
        function updateSeverity() {
            const value = document.getElementById('severitySlider').value;
            document.getElementById('severityValue').textContent = value;
        }

        // Get severity label
        function getSeverityLabel(value) {
            if (value <= 3) return { text: 'Mild', class: 'severity-low' };
            if (value <= 7) return { text: 'Moderate', class: 'severity-medium' };
            return { text: 'Severe', class: 'severity-high' };
        }

        // Rate limiting function
        function checkRateLimit() {
            const now = Date.now();
            if (now - lastAPICall < API_COOLDOWN) {
                const remainingTime = Math.ceil((API_COOLDOWN - (now - lastAPICall)) / 1000);
                document.getElementById('rateLimitSeconds').textContent = remainingTime;
                document.getElementById('rateLimitWarning').style.display = 'flex';
                
                setTimeout(() => {
                    document.getElementById('rateLimitWarning').style.display = 'none';
                }, remainingTime * 1000);
                
                return false;
            }
            lastAPICall = now;
            return true;
        }

        // Consolidate preventions using GPT
        async function consolidatePreventions(matches, userInput) {
            console.log('consolidatePreventions called with', matches.length, 'matches');
            
            if (!apiKey || !settings.consolidatePreventions) {
                return {
                    text: matches.map(m => m.item.prevention).join(' Alternatively, '),
                    isConsolidated: false
                };
            }

            try {
                showStatus('Creating personalized prevention plan...', 'info');
                
                const preventions = matches.map((m, i) => 
                    `Symptom ${i+1}: ${m.item.symptom}\nPrevention: ${m.item.prevention}`
                ).join('\n\n');

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo-0125',
                        messages: [
                            {
                                role: 'system',
                                content: `You are a compassionate anxiety counselor. Given multiple anxiety symptoms and their prevention techniques, create a single, coherent, empathetic prevention plan that addresses all symptoms holistically. 

Guidelines:
- Be warm, understanding, and encouraging
- Start by acknowledging their specific struggle
- Integrate techniques naturally, avoiding repetition
- Provide practical steps in a logical order
- Include both immediate relief techniques and long-term strategies
- Use "you" to speak directly to the person
- Be specific and actionable
- Include gentle reminders about self-compassion
- DO NOT use bullet points or lists - write in flowing paragraphs
- Make it feel like personal advice from a caring professional`
                            },
                            {
                                role: 'user',
                                content: `The person described their symptoms as: "${userInput}"

These match the following symptoms and prevention techniques:
${preventions}

Please create a consolidated, empathetic prevention plan that addresses all these symptoms together.`
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 600
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('AI consolidation successful');
                    return {
                        text: data.choices[0].message.content,
                        isConsolidated: true
                    };
                } else {
                    const error = await response.json();
                    if (error.error?.type === 'insufficient_quota') {
                        showStatus('API quota exceeded. Using standard response.', 'error');
                    } else if (error.error?.type === 'invalid_api_key') {
                        showStatus('Invalid API key. Please check your settings.', 'error');
                    }
                    return {
                        text: matches.map(m => m.item.prevention).join(' Alternatively, '),
                        isConsolidated: false
                    };
                }
                
            } catch (error) {
                console.error('Consolidation error:', error);
                return {
                    text: matches.map(m => m.item.prevention).join(' Alternatively, '),
                    isConsolidated: false
                };
            }
        }

        // Load settings
        function loadSettings() {
            const savedSettings = localStorage.getItem('anxietySettings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
            }
            if (document.getElementById('numMatches')) {
                document.getElementById('numMatches').value = settings.numMatches || 3;
            }
            if (document.getElementById('minConfidence')) {
                document.getElementById('minConfidence').value = settings.minConfidence || 30;
            }
            if (document.getElementById('consolidatePreventions')) {
                document.getElementById('consolidatePreventions').checked = settings.consolidatePreventions !== false;
            }
            updateConsolidationStatus();
        }

        // Save settings
        function saveSettings() {
            settings.numMatches = parseInt(document.getElementById('numMatches').value);
            settings.minConfidence = parseInt(document.getElementById('minConfidence').value);
            settings.consolidatePreventions = document.getElementById('consolidatePreventions').checked;
            localStorage.setItem('anxietySettings', JSON.stringify(settings));
            updateConsolidationStatus();
            showStatus('Settings saved', 'success');
        }

        // Update consolidation status display
        function updateConsolidationStatus() {
            const statusDiv = document.getElementById('consolidationStatus');
            const statusText = document.getElementById('consolidationText');
            
            if (!statusDiv || !statusText) return;
            
            if (settings.consolidatePreventions && apiKey) {
                statusDiv.style.background = '#E8F5E9';
                statusText.innerHTML = '<i class="material-icons" style="font-size: 16px; vertical-align: middle;">check_circle</i> AI consolidation enabled - Will create personalized responses';
                statusText.style.color = '#2E7D32';
            } else if (settings.consolidatePreventions && !apiKey) {
                statusDiv.style.background = '#FFF3E0';
                statusText.innerHTML = '<i class="material-icons" style="font-size: 16px; vertical-align: middle;">warning</i> AI consolidation requires API key';
                statusText.style.color = '#E65100';
            } else {
                statusDiv.style.background = '#FFEBEE';
                statusText.innerHTML = '<i class="material-icons" style="font-size: 16px; vertical-align: middle;">cancel</i> AI consolidation disabled';
                statusText.style.color = '#C62828';
            }
        }

        // Load API key
        function loadApiKey() {
            const savedKey = localStorage.getItem('openai_api_key');
            if (savedKey) {
                apiKey = savedKey;
                document.getElementById('apiKey').value = maskApiKey(savedKey);
                document.getElementById('apiStatus').className = 'api-status connected';
                document.getElementById('apiStatus').innerHTML = '<i class="material-icons" style="font-size: 16px;">cloud_done</i> Connected';
                document.getElementById('apiWarning').style.display = 'none';
            } else {
                document.getElementById('apiWarning').style.display = 'block';
            }
            updateConsolidationStatus();
        }

        // Mask API key for display
        function maskApiKey(key) {
            if (!key) return '';
            return key.substring(0, 7) + '...' + key.substring(key.length - 4);
        }

        // Save API key
        function saveApiKey() {
            const keyInput = document.getElementById('apiKey').value.trim();
            if (keyInput && keyInput.startsWith('sk-')) {
                apiKey = keyInput;
                localStorage.setItem('openai_api_key', keyInput);
                document.getElementById('apiStatus').className = 'api-status connected';
                document.getElementById('apiStatus').innerHTML = '<i class="material-icons" style="font-size: 16px;">cloud_done</i> Connected';
                document.getElementById('apiWarning').style.display = 'none';
                showStatus('API key saved successfully!', 'success');
                document.getElementById('apiKey').value = maskApiKey(keyInput);
                updateConsolidationStatus();
            } else {
                showStatus('Please enter a valid OpenAI API key (starts with sk-)', 'error');
            }
        }

        // Test API key
        async function testApiKey() {
            if (!apiKey) {
                showStatus('Please enter and save an API key first', 'error');
                return;
            }

            if (!checkRateLimit()) {
                showStatus('Please wait before testing again', 'warning');
                return;
            }

            showStatus('Testing API connection...', 'info');
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo-0125',
                        messages: [
                            {role: 'system', content: 'Reply with OK'},
                            {role: 'user', content: 'Test'}
                        ],
                        max_tokens: 10
                    })
                });

                if (response.ok) {
                    showStatus('API connection successful!', 'success');
                } else {
                    const error = await response.json();
                    if (error.error?.type === 'insufficient_quota') {
                        showStatus('API quota exceeded. Please check your OpenAI account.', 'error');
                    } else if (error.error?.type === 'invalid_api_key') {
                        showStatus('Invalid API key. Please check and try again.', 'error');
                    } else {
                        showStatus(`API error: ${error.error?.message || 'Unknown error'}`, 'error');
                    }
                }
            } catch (error) {
                showStatus('Failed to connect to OpenAI API', 'error');
            }
        }

        // Clear API key
        function clearApiKey() {
            if (confirm('Are you sure you want to clear your API key?')) {
                apiKey = '';
                localStorage.removeItem('openai_api_key');
                document.getElementById('apiKey').value = '';
                document.getElementById('apiStatus').className = 'api-status disconnected';
                document.getElementById('apiStatus').innerHTML = '<i class="material-icons" style="font-size: 16px;">cloud_off</i> Not Connected';
                document.getElementById('apiWarning').style.display = 'block';
                showStatus('API key cleared', 'info');
                updateConsolidationStatus();
            }
        }

        // GPT-based symptom matching with follow-up support
        async function gptSymptomMatch(userInput) {
            if (!apiKey) {
                showStatus('Please configure your OpenAI API key in Settings', 'error');
                document.getElementById('resultSection').style.display = 'none';
                return [];
            }

            if (!checkRateLimit()) {
                return [];
            }

            try {
                showStatus('Analyzing your symptoms with AI...', 'info');
                
                const symptomList = anxietyDatabase.map((item, index) => 
                    `${index}: ${item.symptom}`
                ).join('\n');

                const numMatches = settings.numMatches || 3;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo-0125',
                        messages: [
                            {
                                role: 'system',
                                content: `You are a medical symptom matcher for anxiety symptoms. Given a user's description, match it to the ${numMatches} most appropriate symptoms from the list.

If the description is too vague or doesn't clearly match any symptoms (all confidence scores < 30%), respond with a follow-up question:

Available symptoms:
${symptomList}

For clear matches, respond with exactly ${numMatches} matches:
{
    "matches": [
        ${Array(numMatches).fill(0).map(() => `{
            "matched_index": <number>,
            "confidence": <0-100>,
            "reasoning": "<brief explanation>"
        }`).join(',\n        ')}
    ]
}

For unclear/vague descriptions, respond with:
{
    "followup": "Hi there! I'd like to help you better. Could you describe your symptoms in more detail? For example, are you experiencing physical sensations, emotional feelings, or specific thoughts?",
    "matches": []
}`
                            },
                            {
                                role: 'user',
                                content: `Match this symptom description: "${userInput}"`
                            }
                        ],
                        temperature: 0.3,
                        max_tokens: 400
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    if (error.error?.type === 'insufficient_quota') {
                        showStatus('API quota exceeded. Please check your OpenAI account.', 'error');
                    } else if (error.error?.type === 'invalid_api_key') {
                        showStatus('Invalid API key. Please check your settings.', 'error');
                    } else {
                        showStatus(`API error: ${error.error?.message || 'Unknown error'}`, 'error');
                    }
                    return [];
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                try {
                    const result = JSON.parse(content);
                    
                    // Handle follow-up question
                    if (result.followup && (!result.matches || result.matches.length === 0)) {
                        document.getElementById('followupCard').style.display = 'block';
                        document.getElementById('followupText').textContent = result.followup;
                        document.getElementById('resultSection').style.display = 'none';
                        speakPrevention(result.followup);
                        return [];
                    }
                    
                    const matches = [];
                    
                    if (result.matches && Array.isArray(result.matches)) {
                        result.matches.forEach(match => {
                            const matchedItem = anxietyDatabase[match.matched_index];
                            if (matchedItem) {
                                matches.push({
                                    item: matchedItem,
                                    score: match.confidence / 100,
                                    reasoning: match.reasoning
                                });
                            }
                        });
                    }
                    
                    return matches;
                } catch (parseError) {
                    console.error('Failed to parse GPT response:', parseError);
                    return [];
                }
                
            } catch (error) {
                console.error('GPT matching error:', error);
                showStatus('Failed to analyze symptoms. Please check your API key.', 'error');
                return [];
            }
        }

        // Process symptoms (GPT only)
        async function processSymptoms(userInput) {
            if (!apiKey) {
                showStatus('Please configure your OpenAI API key in Settings', 'error');
                document.getElementById('apiWarning').style.display = 'block';
                return;
            }
            
            showStatus('Processing your symptoms...', 'info');
            document.getElementById('followupCard').style.display = 'none';
            
            const results = await gptSymptomMatch(userInput);
            
            const minConfidence = (settings.minConfidence || 30) / 100;
            const significantMatches = results.filter(r => r.score >= minConfidence);
            
            console.log(`Found ${significantMatches.length} significant matches`);
            
            if (significantMatches.length > 0) {
                let combinedMatch = {
                    item: {
                        symptom: '',
                        prevention: '',
                        nlpConflict: ''
                    },
                    score: 0,
                    reasoning: '',
                    isMultiple: significantMatches.length > 1,
                    wasConsolidated: false
                };
                
                combinedMatch.item.symptom = significantMatches.map(m => m.item.symptom).join(' / ');
                combinedMatch.item.nlpConflict = significantMatches.map(m => m.item.nlpConflict).join(' and ');
                
                // AI consolidation for multiple matches
                if (significantMatches.length > 1 && settings.consolidatePreventions) {
                    console.log('Attempting AI consolidation...');
                    const consolidationResult = await consolidatePreventions(significantMatches, userInput);
                    combinedMatch.item.prevention = consolidationResult.text;
                    combinedMatch.wasConsolidated = consolidationResult.isConsolidated;
                } else {
                    combinedMatch.item.prevention = significantMatches.map(m => m.item.prevention)
                        .join(' Alternatively, ');
                    combinedMatch.wasConsolidated = false;
                }
                
                const reasonings = significantMatches
                    .filter(m => m.reasoning)
                    .map((m, i) => `Match ${i+1}: ${m.reasoning}`);
                if (reasonings.length > 0) {
                    combinedMatch.reasoning = reasonings.join(' ');
                }
                
                combinedMatch.score = significantMatches.reduce((sum, m) => sum + m.score, 0) / significantMatches.length;
                combinedMatch.matches = significantMatches;
                
                displayResult(combinedMatch, userInput);
                saveToHistory(userInput, combinedMatch);
                speakPrevention(combinedMatch.item.prevention);
            } else if (results.length === 0 && document.getElementById('followupCard').style.display !== 'block') {
                showStatus('No matching symptoms found. Please try describing your symptoms differently.', 'error');
                document.getElementById('resultSection').style.display = 'none';
            }
        }

        // Display results with severity
        function displayResult(match, userInput) {
            document.getElementById('resultSection').style.display = 'block';
            
            const indicator = document.getElementById('matchIndicator');
            if (match.wasConsolidated) {
                indicator.innerHTML = '<i class="material-icons" style="font-size: 14px;">auto_awesome</i> AI-Personalized';
                indicator.className = 'chip chip-success';
                indicator.style.display = 'inline-block';
            } else if (match.matches && match.matches.length > 1) {
                indicator.textContent = `${match.matches.length} Matches`;
                indicator.className = 'chip';
                indicator.style.display = 'inline-block';
            } else {
                indicator.style.display = 'none';
            }
            
            if (match.matches && match.matches.length > 1) {
                const symptomHtml = match.matches.map((m, i) => {
                    const confidence = Math.round(m.score * 100);
                    return `<div style="margin: 8px 0; padding: 8px; background: #F5F5F5; border-radius: 4px;">
                        <span class="chip" style="margin-right: 8px;">${confidence}%</span>
                        ${m.item.symptom}
                    </div>`;
                }).join('');
                document.getElementById('matchedSymptom').innerHTML = symptomHtml;
            } else {
                document.getElementById('matchedSymptom').innerHTML = `<div style="margin: 8px 0;">${match.item.symptom}</div>`;
            }
            
            const confidence = Math.min(Math.round(match.score * 100), 100);
            document.getElementById('confidenceScore').textContent = confidence + '%';
            document.getElementById('confidenceFill').style.width = confidence + '%';
            
            // Display severity
            const severityValue = document.getElementById('severitySlider').value;
            const severity = getSeverityLabel(severityValue);
            const severityBadge = document.getElementById('severityBadge');
            severityBadge.textContent = `${severity.text} (${severityValue}/10)`;
            severityBadge.className = `severity-badge ${severity.class}`;
            
            if (match.reasoning) {
                document.getElementById('aiReasoning').style.display = 'block';
                document.getElementById('reasoningText').textContent = match.reasoning;
            } else {
                document.getElementById('aiReasoning').style.display = 'none';
            }
            
            document.getElementById('nlpConflict').innerHTML = match.item.nlpConflict;
            
            const preventionDiv = document.getElementById('preventionText');
            
            if (match.wasConsolidated) {
                preventionDiv.innerHTML = `
                    <div class="prevention-box">
                        <div class="ai-badge">
                            <i class="material-icons" style="font-size: 14px; vertical-align: middle;">auto_awesome</i>
                            AI-Personalized Prevention Plan
                        </div>
                        <div style="color: rgba(0,0,0,0.87); line-height: 1.8;">
                            ${match.item.prevention.split('\n\n')
                                .map(p => `<p style="margin: 12px 0;">${p.trim()}</p>`)
                                .join('')}
                        </div>
                    </div>
                `;
            } else {
                preventionDiv.innerHTML = `<div class="prevention-box">
                    ${match.item.prevention
                        .replace(/Alternatively,/g, '<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(0,0,0,0.12);"><strong style="color: var(--primary);">Alternative Approach:</strong></div>')
                        .replace(/Practice/g, '<strong>Practice</strong>')
                        .replace(/Consider/g, '<strong>Consider</strong>')
                        .replace(/Use/g, '<strong>Use</strong>')}
                </div>`;
            }
            
            showStatus(match.wasConsolidated ? 
                'AI created a personalized prevention plan for you!' : 
                'Analysis complete! Prevention techniques ready.', 'success');
        }

        // Save to history with severity
        function saveToHistory(userInput, match) {
            let history = JSON.parse(localStorage.getItem('anxietyHistory') || '[]');
            
            const severityValue = document.getElementById('severitySlider').value;
            const severity = getSeverityLabel(severityValue);
            
            const entry = {
                date: new Date().toISOString(),
                userInput: userInput,
                matchedSymptom: match.item.symptom,
                prevention: match.item.prevention,
                nlpConflict: match.item.nlpConflict,
                confidence: Math.round(match.score * 100),
                numMatches: match.matches ? match.matches.length : 1,
                consolidated: match.wasConsolidated || false,
                severity: {
                    value: severityValue,
                    label: severity.text
                }
            };
            
            history.unshift(entry);
            if (history.length > 50) history = history.slice(0, 50);
            
            localStorage.setItem('anxietyHistory', JSON.stringify(history));
            loadHistory();
        }

        // Load history with severity display
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('anxietyHistory') || '[]');
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <i class="material-icons">history</i>
                        <p>No history yet</p>
                        <p style="font-size: 14px;">Start by recording your symptoms using the microphone</p>
                    </div>
                `;
                return;
            }
            
            historyList.innerHTML = history.map(entry => {
                const date = new Date(entry.date);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                
                const severityClass = entry.severity ? 
                    (entry.severity.value <= 3 ? 'severity-low' : 
                     entry.severity.value <= 7 ? 'severity-medium' : 'severity-high') : '';
                
                return `
                    <div class="history-item">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="color: rgba(0,0,0,0.54); font-size: 12px;">${dateStr}</span>
                            ${entry.consolidated ? '<span class="chip chip-success"><i class="material-icons" style="font-size: 12px;">auto_awesome</i> AI</span>' : ''}
                        </div>
                        <div style="margin: 8px 0;">
                            <strong>Input:</strong> ${entry.userInput}
                        </div>
                        <div style="margin: 8px 0;">
                            <strong>Matched:</strong> ${entry.matchedSymptom}
                        </div>
                        <div style="margin: 8px 0; display: flex; gap: 8px; flex-wrap: wrap;">
                            <span class="chip">${entry.confidence}% confidence</span>
                            <span class="chip">${entry.numMatches} match${entry.numMatches > 1 ? 'es' : ''}</span>
                            ${entry.severity ? `<span class="severity-badge ${severityClass}">${entry.severity.label} (${entry.severity.value}/10)</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Clear history
        function clearHistory() {
            if (confirm('Are you sure you want to clear all history? This cannot be undone.')) {
                localStorage.removeItem('anxietyHistory');
                loadHistory();
                showStatus('History cleared', 'success');
            }
        }

        // Export/Import history
        function exportHistory() {
            const history = localStorage.getItem('anxietyHistory') || '[]';
            const blob = new Blob([history], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'anxiety_history_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
            showStatus('History exported', 'success');
        }

        function importHistory() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        localStorage.setItem('anxietyHistory', JSON.stringify(data));
                        loadHistory();
                        showStatus('History imported successfully', 'success');
                    } catch (error) {
                        showStatus('Invalid history file', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Load database
        function loadDatabase() {
            const tbody = document.getElementById('databaseBody');
            tbody.innerHTML = anxietyDatabase.map(item => `
                <tr>
                    <td>${item.symptom}</td>
                    <td style="font-size: 14px;">${item.prevention}</td>
                    <td style="font-style: italic; color: rgba(0,0,0,0.67);">${item.nlpConflict}</td>
                    <td>
                        <button class="btn btn-text" onclick="speakPrevention('${item.prevention.replace(/'/g, "\\'")}')">
                            <i class="material-icons">volume_up</i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Switch tabs
        function switchTab(event, tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (event && event.target) {
                let tab = event.target;
                if (tab.tagName === 'I') {
                    tab = tab.parentElement;
                }
                tab.classList.add('active');
            } else {
                document.querySelector(`.tab:nth-child(${tabName === 'voice' ? 1 : tabName === 'history' ? 2 : tabName === 'database' ? 3 : 4})`).classList.add('active');
            }
            
            document.getElementById(tabName).classList.add('active');
        }

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status-bar status-${type}`;
            statusDiv.innerHTML = message;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 4000);
        }

        // Speech recognition functions
        async function checkPermissions() {
            try {
                if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                    showStatus('Your browser does not support speech recognition. Please use Chrome or Edge.', 'error');
                    document.getElementById('permissionCard').style.display = 'block';
                    document.getElementById('micButton').disabled = true;
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Permission check error:', error);
                return false;
            }
        }

        async function requestPermissions() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                
                initSpeechRecognition();
                document.getElementById('permissionCard').style.display = 'none';
                hasPermissions = true;
                document.getElementById('status').textContent = 'Click the microphone to describe your symptoms';
                showStatus('Microphone access granted!', 'success');
                
            } catch (error) {
                console.error('Permission error:', error);
                showStatus('Microphone access denied. Please enable it in your browser settings.', 'error');
            }
        }

        function initSpeechRecognition() {
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onstart = function() {
                    isRecording = true;
                    document.getElementById('micButton').classList.add('listening');
                    document.getElementById('micIcon').textContent = 'hearing';
                    document.getElementById('status').textContent = 'Listening... Describe your symptoms';
                };

                recognition.onresult = function(event) {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript = transcript;
                        }
                    }
                    
                    if (interimTranscript) {
                        document.getElementById('transcript').innerHTML = 
                            `<strong>Listening:</strong> ${interimTranscript}`;
                    }
                    
                    if (finalTranscript) {
                        document.getElementById('transcript').innerHTML = 
                            `<strong>You said:</strong> ${finalTranscript}`;
                        processSymptoms(finalTranscript);
                    }
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    stopRecording();
                    
                    if (event.error === 'not-allowed') {
                        document.getElementById('permissionCard').style.display = 'block';
                    } else if (event.error === 'no-speech') {
                        showStatus('No speech detected. Please try again.', 'error');
                    }
                };

                recognition.onend = function() {
                    stopRecording();
                };

                hasPermissions = true;
                document.getElementById('status').textContent = 'Click the microphone to describe your symptoms';

            } catch (error) {
                console.error('Failed to initialize speech recognition:', error);
                showStatus('Failed to initialize speech recognition', 'error');
            }
        }

        async function startRecording() {
            if (!apiKey) {
                showStatus('Please configure your OpenAI API key in Settings first', 'error');
                switchTab(null, 'settings');
                return;
            }
            
            if (!hasPermissions) {
                await requestPermissions();
                return;
            }

            if (!recognition) {
                showStatus('Speech recognition not initialized. Please refresh the page.', 'error');
                return;
            }

            if (isRecording) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('Failed to start recording:', error);
                    showStatus('Failed to start recording. Please try again.', 'error');
                }
            }
        }

        function stopRecording() {
            isRecording = false;
            document.getElementById('micButton').classList.remove('listening');
            document.getElementById('micIcon').textContent = 'mic';
            document.getElementById('status').textContent = 'Click the microphone to describe your symptoms';
        }

        function speakPrevention(text) {
            if (synthesis.speaking) {
                synthesis.cancel();
            }
            
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 1;
                
                utterance.onerror = function(event) {
                    showStatus('Could not read aloud. Check your speaker settings.', 'error');
                };
                
                synthesis.speak(utterance);
            }, 100);
        }

        // Initialize app
        window.onload = async function() {
            console.log('Anxiety Helper v2.1 initialized');
            
            loadSettings();
            loadApiKey();
            loadHistory();
            loadDatabase();
            
            const canUseSpeech = await checkPermissions();
            if (canUseSpeech) {
                initSpeechRecognition();
            } else {
                document.getElementById('permissionCard').style.display = 'block';
            }
        };
    </script>
</body>
</html>
