<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Anxiety Helper - AI-Powered</title>
    <style>
        /* --- styles unchanged --- */
        * { margin:0; padding:0; box-sizing:border-box }
        body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:10px }
        .container { max-width:600px; margin:0 auto; background:white; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.3); overflow:hidden }
        .header { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:20px; text-align:center }
        .header h1 { font-size:24px; margin-bottom:5px }
        .header p { font-size:14px; opacity:0.9 }
        .tabs { display:flex; background:#f5f5f5; border-bottom:2px solid #e0e0e0 }
        .tab { flex:1; padding:15px; text-align:center; cursor:pointer; background:transparent; border:none; font-size:16px; font-weight:500; color:#666; transition:all 0.3s }
        .tab.active { background:white; color:#667eea; border-bottom:3px solid #667eea }
        .tab-content { display:none; padding:20px; animation:fadeIn 0.3s }
        .tab-content.active { display:block }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        /* ... rest of your CSS unchanged ... */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ§  Anxiety Helper</h1>
            <p>AI-Powered Symptom Matching & Support</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(event, 'voice')">Voice Input</button>
            <button class="tab" onclick="switchTab(event, 'history')">History</button>
            <button class="tab" onclick="switchTab(event, 'database')">Database</button>
            <button class="tab" onclick="switchTab(event, 'settings')">Settings</button>
        </div>

        <div id="voice" class="tab-content active">
            <!-- API setup, permissions, mic button, etc. unchanged -->
            <!-- ... -->
            <div id="resultSection" style="display: none;">
                <div class="result-card">
                    <h3>Analysis Results</h3>
                    <p><span class="label">Matched Symptom:</span><span id="matchedSymptom"></span></p>
                    <p><span class="label">Confidence Score:</span><span id="confidenceScore"></span></p>
                    <div class="confidence-meter">
                        <div class="confidence-fill" id="confidenceFill"></div>
                    </div>
                    <div id="aiReasoning" class="ai-reasoning" style="display: none;">
                        <strong>AI Reasoning:</strong> <span id="reasoningText"></span>
                    </div>
                    <p><span class="label">NLP Conflict:</span><span id="nlpConflict"></span></p>
                    <p><span class="label">Prevention Technique:</span></p>
                    <p id="preventionText" style="background: white; padding: 10px; border-radius: 5px; margin-top: 5px;"></p>
                </div>
            </div>
        </div>

        <!-- History, Database, Settings tabs unchanged -->
    </div>

    <script>
        /* --- your anxietyDatabase and existing functions remain as-is --- */

        let recognition = null;
        let isRecording = false;
        let synthesis = window.speechSynthesis;
        let hasPermissions = false;
        let apiKey = '';

        /* loadApiKey, maskApiKey, saveApiKey, testApiKey, clearApiKey unchanged */
        /* gptSymptomMatch unchanged */

        // ðŸ”¹ New function: refine prevention with GPT
        async function gptRefinePrevention(preventionText, userInput) {
            if (!apiKey) {
                showStatus('No API key set. Showing default prevention.', 'error');
                return preventionText;
            }
            try {
                showStatus('Asking GPT for refined prevention...', 'info');
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            { role: 'system', content: 'You are a mental health assistant. Suggest concise, safe, practical prevention strategies. Avoid medical prescriptions.' },
                            { role: 'user', content: `User described symptoms as: "${userInput}". The app suggests this prevention: "${preventionText}". Please provide a refined prevention strategy in 3-5 sentences.` }
                        ],
                        temperature: 0.7,
                        max_tokens: 200
                    })
                });
                if (!response.ok) {
                    const error = await response.json();
                    showStatus(`GPT error: ${error.error?.message || 'Unknown error'}`, 'error');
                    return preventionText;
                }
                const data = await response.json();
                const refined = data.choices[0].message.content.trim();
                return refined || preventionText;
            } catch (err) {
                console.error('GPT refine error:', err);
                showStatus('GPT prevention refinement failed.', 'error');
                return preventionText;
            }
        }

        // ðŸ”¹ Modified displayResult: now calls GPT for refined prevention
        function displayResult(match, userInput) {
            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('matchedSymptom').textContent = match.item.symptom;
            const confidence = Math.min(Math.round(match.score * 100), 100);
            document.getElementById('confidenceScore').textContent = confidence + '%';
            document.getElementById('confidenceFill').style.width = confidence + '%';
            if (match.reasoning) {
                document.getElementById('aiReasoning').style.display = 'block';
                document.getElementById('reasoningText').textContent = match.reasoning;
            } else {
                document.getElementById('aiReasoning').style.display = 'none';
            }
            document.getElementById('nlpConflict').textContent = match.item.nlpConflict;

            // async GPT refinement
            (async () => {
                const refined = await gptRefinePrevention(match.item.prevention, userInput);
                document.getElementById('preventionText').textContent = refined;
                speakPrevention(refined);
            })();

            showStatus('Match found! Reading prevention technique...', 'success');
        }

        /* rest of your code unchanged: search functions, history, permissions, speech, etc. */

        window.onload = async function() {
            loadApiKey();
            loadHistory();
            loadDatabase();
            const canUseSpeech = await checkPermissions();
            if (canUseSpeech) initSpeechRecognition();
            else document.getElementById('permissionCard').style.display = 'block';
        };
    </script>
</body>
</html>
