<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Anxiety Helper - AI-Powered</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .api-setup {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        .api-setup h4 {
            color: #1565c0;
            margin-bottom: 15px;
        }

        .api-setup input {
            width: 100%;
            padding: 10px;
            border: 1px solid #2196f3;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
        }

        .api-setup button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }

        .api-setup button:hover {
            background: #1976d2;
        }

        .api-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 10px;
        }

        .api-status.connected {
            background: #4caf50;
            color: white;
        }

        .api-status.disconnected {
            background: #f44336;
            color: white;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .permission-card {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }

        .permission-card h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        .permission-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin: 10px;
            transition: all 0.3s;
        }

        .permission-btn:hover {
            background: #218838;
            transform: scale(1.05);
        }

        .voice-section {
            text-align: center;
            padding: 20px;
        }

        .mic-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            position: relative;
        }

        .mic-button:hover {
            transform: scale(1.05);
        }

        .mic-button.listening {
            animation: pulse 1.5s infinite;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .mic-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(245, 87, 108, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(245, 87, 108, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 87, 108, 0); }
        }

        .transcript {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            min-height: 60px;
            text-align: left;
        }

        .result-card {
            background: #f0f4ff;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }

        .result-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .result-card p {
            margin: 10px 0;
            line-height: 1.6;
        }

        .result-card .label {
            font-weight: 600;
            color: #333;
            display: inline-block;
            margin-right: 5px;
            min-width: 150px;
        }

        .ai-reasoning {
            background: #fff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 3px solid #2196f3;
            font-style: italic;
            color: #555;
        }

        .match-indicator {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 10px;
            font-weight: normal;
        }

        .confidence-meter {
            margin: 10px 0;
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ffaa00, #44ff44);
            transition: width 0.5s ease;
        }

        .prevention-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            line-height: 1.8;
        }

        .prevention-section p {
            margin: 12px 0;
        }

        .history-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .history-item .date {
            color: #999;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .history-item .symptom {
            color: #667eea;
            font-weight: 600;
            margin: 5px 0;
        }

        .clear-history {
            background: #ff4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .database-table {
            overflow-x: auto;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        tr:hover {
            background: #f9f9f9;
        }

        .speak-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .status-message {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: 500;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .method-selector {
            margin: 15px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .method-selector label {
            display: block;
            margin: 10px 0;
            cursor: pointer;
        }

        .method-selector input[type="radio"] {
            margin-right: 10px;
        }

        .settings-section {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .settings-section h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .debug-panel {
            background: #1e1e1e;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧠 Anxiety Helper</h1>
            <p>AI-Powered Symptom Matching & Support</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(event, 'voice')">Voice Input</button>
            <button class="tab" onclick="switchTab(event, 'history')">History</button>
            <button class="tab" onclick="switchTab(event, 'database')">Database</button>
            <button class="tab" onclick="switchTab(event, 'settings')">Settings</button>
        </div>

        <div id="voice" class="tab-content active">
            <div id="apiSetup" class="api-setup">
                <h4>🔑 OpenAI API Setup</h4>
                <p style="font-size: 14px; color: #555; margin-bottom: 10px;">
                    Enter your OpenAI API key for intelligent symptom matching. Your key is stored locally and never sent to any server except OpenAI.
                </p>
                <input type="password" id="apiKey" placeholder="sk-..." />
                <div style="margin-top: 10px;">
                    <button onclick="saveApiKey()">Save Key</button>
                    <button onclick="testApiKey()">Test Connection</button>
                    <button onclick="clearApiKey()">Clear Key</button>
                    <span id="apiStatus" class="api-status disconnected">Not Connected</span>
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    Get your API key from: <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a>
                </p>
            </div>

            <div id="permissionCard" class="permission-card" style="display: none;">
                <h4>📱 Enable Permissions</h4>
                <p>This app needs microphone access to hear your symptoms and speaker access to read prevention techniques.</p>
                <button class="permission-btn" onclick="requestPermissions()">
                    🎤 Enable Microphone & Speaker
                </button>
                <p style="margin-top: 15px; font-size: 12px; color: #666;">
                    If prompted, please click "Allow" in your browser
                </p>
            </div>

            <div class="method-selector">
                <h4>Search Method:</h4>
                <label>
                    <input type="radio" name="searchMethod" value="gpt" checked>
                    GPT-3.5 (Most accurate, requires API key)
                </label>
                <label>
                    <input type="radio" name="searchMethod" value="enhanced">
                    Enhanced Keyword (No API needed, faster)
                </label>
                <label>
                    <input type="radio" name="searchMethod" value="basic">
                    Basic Keyword (Original method)
                </label>
                <div style="margin-top: 10px; padding: 10px; background: #f0f4ff; border-radius: 5px;">
                    <button onclick="testConsolidation()" style="background: #9c27b0; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                        🧪 Test AI Consolidation
                    </button>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        <em>Test with: "I feel breathless, heart racing, and panicky"</em>
                    </div>
                </div>
            </div>

            <div class="voice-section">
                <button class="mic-button" id="micButton" onclick="startRecording()">
                    <span id="micIcon">🎤</span>
                </button>
                <p style="margin-top: 15px; color: #666;" id="status">Click microphone to start</p>
            </div>

            <div class="transcript" id="transcript">
                <p style="color: #999;">Your spoken symptoms will appear here...</p>
            </div>

            <div id="resultSection" style="display: none;">
                <div class="result-card">
                    <h3>Analysis Results <span id="matchIndicator" class="match-indicator" style="display: none;">Combined Match</span></h3>
                    <p><span class="label">Matched Symptom(s):</span></p>
                    <div id="matchedSymptom" style="margin-left: 20px;"></div>
                    <p><span class="label">Confidence Score:</span><span id="confidenceScore"></span></p>
                    <div class="confidence-meter">
                        <div class="confidence-fill" id="confidenceFill"></div>
                    </div>
                    <div id="aiReasoning" class="ai-reasoning" style="display: none;">
                        <strong>AI Reasoning:</strong> <span id="reasoningText"></span>
                    </div>
                    <p><span class="label">NLP Conflict(s):</span></p>
                    <div id="nlpConflict" style="margin-left: 20px; font-style: italic;"></div>
                    <p><span class="label">Prevention Technique(s):</span></p>
                    <div id="preventionText" class="prevention-section"></div>
                </div>
            </div>

            <div id="statusMessage"></div>

            <div id="debugPanel" class="debug-panel" style="display: none;">
                <div style="color: #fff; margin-bottom: 10px;">
                    <strong>🐛 DEBUG CONSOLE</strong>
                </div>
                <div id="debugContent"></div>
            </div>
        </div>

        <div id="history" class="tab-content">
            <h3 style="margin-bottom: 15px;">Your History</h3>
            <div id="historyList"></div>
            <button class="clear-history" onclick="clearHistory()">Clear All History</button>
        </div>

        <div id="database" class="tab-content">
            <h3 style="margin-bottom: 15px;">Symptom Database</h3>
            <div class="database-table">
                <table id="databaseTable">
                    <thead>
                        <tr>
                            <th>Symptom</th>
                            <th>Prevention</th>
                            <th>NLP Conflict</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="databaseBody"></tbody>
                </table>
            </div>
        </div>

        <div id="settings" class="tab-content">
            <h3 style="margin-bottom: 15px;">Settings</h3>
            <div class="settings-section">
                <h4>Matching Configuration</h4>
                <p style="margin-bottom: 10px;">
                    <label for="numMatches">Number of symptoms to match (GPT only):</label>
                    <select id="numMatches" onchange="saveSettings()" style="padding: 5px; margin-left: 10px;">
                        <option value="1">1 symptom</option>
                        <option value="2">2 symptoms</option>
                        <option value="3" selected>3 symptoms</option>
                        <option value="4">4 symptoms</option>
                        <option value="5">5 symptoms</option>
                    </select>
                </p>
                <p style="margin-bottom: 10px;">
                    <label for="minConfidence">Minimum confidence to include match:</label>
                    <select id="minConfidence" onchange="saveSettings()" style="padding: 5px; margin-left: 10px;">
                        <option value="20">20%</option>
                        <option value="30" selected>30%</option>
                        <option value="40">40%</option>
                        <option value="50">50%</option>
                    </select>
                </p>
                <p style="margin-bottom: 10px;">
                    <label>
                        <input type="checkbox" id="consolidatePreventions" checked onchange="saveSettings()">
                        🤖 Use AI to create consolidated, empathetic prevention advice
                    </label>
                </p>
                <div id="consolidationStatus" style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 13px;">
                    <strong>AI Consolidation:</strong> 
                    <span id="consolidationText">Enabled - Will create personalized responses for multiple matches</span>
                </div>
            </div>
            <div class="settings-section">
                <h4>API Configuration</h4>
                <p>Current API Key: <span id="currentKeyStatus">Not set</span></p>
                <p id="apiWarning" style="color: #ff6b6b; font-size: 13px; margin-top: 5px; display: none;">
                    ⚠️ API key required for GPT matching and AI consolidation
                </p>
                <button onclick="exportHistory()">Export History</button>
                <button onclick="importHistory()">Import History</button>
            </div>
            <div class="settings-section">
                <h4>Privacy</h4>
                <p style="font-size: 14px; color: #666;">
                    • Your API key is stored locally in your browser<br>
                    • Voice data is processed by your browser's speech recognition<br>
                    • OpenAI API calls are made directly from your browser<br>
                    • No data is stored on any external server<br>
                    • AI consolidation requires GPT mode and multiple matches
                </p>
            </div>
        </div>
    </div>

    <script>
        // Comprehensive anxiety symptom database
        const anxietyDatabase = [
            {
                symptom: "Racing heart or palpitations",
                keywords: ["heart", "racing", "palpitations", "heartbeat", "pulse", "chest", "pounding", "fast heart", "rapid heartbeat"],
                prevention: "Practice deep breathing exercises: Inhale for 4 counts, hold for 4, exhale for 6. Repeat 5-10 times. Consider regular cardio exercise to improve heart rate variability.",
                nlpConflict: "Physical sensations vs. safety beliefs"
            },
            {
                symptom: "Difficulty breathing or shortness of breath",
                keywords: ["breathing", "breath", "breathless", "air", "suffocating", "can't breathe", "shortness", "gasping", "hyperventilating", "tight chest"],
                prevention: "Use the 5-4-3-2-1 grounding technique: Name 5 things you see, 4 you can touch, 3 you hear, 2 you smell, 1 you taste. Practice diaphragmatic breathing daily.",
                nlpConflict: "Control vs. surrender patterns"
            },
            {
                symptom: "Excessive worry about the future",
                keywords: ["worry", "future", "anxious", "concerned", "overthinking", "what if", "scared", "tomorrow", "next week"],
                prevention: "Set a 'worry window' - dedicate 15 minutes daily to process worries, then redirect thoughts. Practice mindfulness meditation focusing on present moment awareness.",
                nlpConflict: "Future projection vs. present reality"
            },
            {
                symptom: "Feeling overwhelmed or out of control",
                keywords: ["overwhelmed", "control", "too much", "can't handle", "stressed", "pressure", "chaos", "losing it"],
                prevention: "Break tasks into smaller steps. Create a priority matrix: urgent/important quadrants. Practice the STOP technique: Stop, Take a breath, Observe, Proceed mindfully.",
                nlpConflict: "All-or-nothing thinking patterns"
            },
            {
                symptom: "Trouble sleeping or insomnia",
                keywords: ["sleep", "insomnia", "can't sleep", "awake", "tired", "restless nights", "tossing turning"],
                prevention: "Establish a wind-down routine 1 hour before bed. No screens, practice progressive muscle relaxation. Keep a worry journal beside your bed to offload thoughts.",
                nlpConflict: "Active mind vs. rest needs"
            },
            {
                symptom: "Muscle tension or body aches",
                keywords: ["tension", "muscle", "tight", "ache", "pain", "stiff", "sore", "shoulders", "neck", "back"],
                prevention: "Practice progressive muscle relaxation: Tense and release each muscle group for 5 seconds. Consider yoga or gentle stretching. Take magnesium supplements after consulting a doctor.",
                nlpConflict: "Holding vs. releasing patterns"
            },
            {
                symptom: "Difficulty concentrating or mind going blank",
                keywords: ["concentrate", "focus", "blank", "mind", "distracted", "foggy", "can't think", "forget"],
                prevention: "Use the Pomodoro Technique: 25 minutes focus, 5 minute break. Practice single-tasking. Try brain-training exercises or puzzles to improve cognitive flexibility.",
                nlpConflict: "Mental overload vs. clarity needs"
            },
            {
                symptom: "Irritability or restlessness",
                keywords: ["irritable", "angry", "restless", "agitated", "annoyed", "frustrated", "on edge", "snappy", "fidgety"],
                prevention: "Engage in physical activity to release tension. Practice self-compassion exercises. Set clear boundaries and communicate needs assertively.",
                nlpConflict: "Internal pressure vs. external demands"
            },
            {
                symptom: "Avoiding social situations",
                keywords: ["avoiding", "social", "isolation", "alone", "withdraw", "hide", "people", "crowds", "parties"],
                prevention: "Start with small, manageable social goals. Practice self-compassion. Prepare conversation starters. Use the 3-3-3 rule: name 3 things you see, hear, and can move.",
                nlpConflict: "Safety vs. connection needs"
            },
            {
                symptom: "Panic attacks or sudden fear",
                keywords: ["panic", "attack", "fear", "terror", "dying", "losing control", "sudden", "intense", "scared"],
                prevention: "Learn to recognize early warning signs. Practice TIPP: Temperature change, Intense exercise, Paced breathing, Paired muscle relaxation. Create a panic attack action plan.",
                nlpConflict: "Fight-or-flight vs. actual threat"
            },
            {
                symptom: "Constant fatigue or exhaustion",
                keywords: ["tired", "fatigue", "exhausted", "no energy", "drained", "worn out", "weak", "sleepy", "lethargic"],
                prevention: "Maintain consistent sleep schedule. Limit caffeine intake. Practice energy management: match activities to energy levels. Consider vitamin D and B12 levels check.",
                nlpConflict: "Hypervigilance vs. rest requirements"
            },
            {
                symptom: "Digestive issues or stomach problems",
                keywords: ["stomach", "digestive", "nausea", "sick", "belly", "gut", "bathroom", "upset stomach", "butterflies"],
                prevention: "Practice mindful eating. Reduce caffeine and alcohol. Try gut-friendly foods: probiotics, fiber. Consider the gut-brain connection through vagus nerve exercises.",
                nlpConflict: "Gut feelings vs. mental processing"
            },
            {
                symptom: "Sweating or trembling",
                keywords: ["sweating", "sweat", "trembling", "shaking", "tremor", "hot", "cold", "clammy", "shivering"],
                prevention: "Keep cooling aids handy. Practice acceptance of physical symptoms. Use positive self-talk. Consider beta-blockers for performance anxiety (consult doctor).",
                nlpConflict: "Visibility fears vs. authenticity"
            },
            {
                symptom: "Fear of losing control or going crazy",
                keywords: ["crazy", "losing mind", "going mad", "insane", "losing it", "breakdown", "snap", "psychotic", "unreal"],
                prevention: "Remind yourself: anxiety is uncomfortable but not dangerous. Practice reality testing. Keep a symptom diary to identify patterns. Seek professional support.",
                nlpConflict: "Catastrophic thinking vs. reality"
            },
            {
                symptom: "Perfectionism or fear of making mistakes",
                keywords: ["perfect", "mistakes", "failure", "wrong", "not good enough", "mess up", "disappoint", "standards"],
                prevention: "Set 'good enough' standards. Practice deliberate imperfection. Celebrate small wins. Use the 80/20 rule: 80% perfect is often sufficient.",
                nlpConflict: "Ideal self vs. human self"
            }
        ];

        let recognition = null;
        let isRecording = false;
        let synthesis = window.speechSynthesis;
        let hasPermissions = false;
        let apiKey = '';
        let settings = {
            numMatches: 3,
            minConfidence: 30,
            consolidatePreventions: true
        };

        // NEW FUNCTION: Consolidate preventions using GPT
        async function consolidatePreventions(matches, userInput) {
            console.log('=== consolidatePreventions FUNCTION CALLED ===');
            console.log('Matches:', matches.length);
            console.log('API Key:', !!apiKey);
            console.log('Settings consolidate:', settings.consolidatePreventions);
            
            if (!apiKey || !settings.consolidatePreventions) {
                console.log('Skipping consolidation - no key or disabled');
                return {
                    text: matches.map(m => m.item.prevention).join(' Alternatively, '),
                    isConsolidated: false
                };
            }

            try {
                console.log('Making GPT API call for consolidation...');
                showStatus('🤖 Creating personalized prevention plan with AI...', 'info');
                
                const preventions = matches.map((m, i) => 
                    `Symptom ${i+1}: ${m.item.symptom}\nPrevention: ${m.item.prevention}`
                ).join('\n\n');

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: `You are a compassionate anxiety counselor. Given multiple anxiety symptoms and their prevention techniques, create a single, coherent, empathetic prevention plan that addresses all symptoms holistically. 

Guidelines:
- Be warm, understanding, and encouraging
- Start by acknowledging their specific struggle
- Integrate techniques naturally, avoiding repetition
- Provide practical steps in a logical order
- Include both immediate relief techniques and long-term strategies
- Use "you" to speak directly to the person
- Be specific and actionable
- Include gentle reminders about self-compassion
- DO NOT use bullet points or lists - write in flowing paragraphs
- Make it feel like personal advice from a caring professional`
                            },
                            {
                                role: 'user',
                                content: `The person described their symptoms as: "${userInput}"

These match the following symptoms and prevention techniques:
${preventions}

Please create a consolidated, empathetic prevention plan that addresses all these symptoms together.`
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 600
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ GPT consolidation successful!');
                    showStatus('✨ AI prevention plan created successfully!', 'success');
                    return {
                        text: data.choices[0].message.content,
                        isConsolidated: true
                    };
                } else {
                    const error = await response.json();
                    console.error('GPT consolidation failed:', error);
                    showStatus('AI consolidation failed, using standard format', 'error');
                    return {
                        text: matches.map(m => m.item.prevention).join(' Alternatively, '),
                        isConsolidated: false
                    };
                }
                
            } catch (error) {
                console.error('Consolidation error:', error);
                showStatus('AI consolidation error, using standard format', 'error');
                return {
                    text: matches.map(m => m.item.prevention).join(' Alternatively, '),
                    isConsolidated: false
                };
            }
        }

        // Load settings
        function loadSettings() {
            const savedSettings = localStorage.getItem('anxietySettings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
            }
            if (document.getElementById('numMatches')) {
                document.getElementById('numMatches').value = settings.numMatches || 3;
            }
            if (document.getElementById('minConfidence')) {
                document.getElementById('minConfidence').value = settings.minConfidence || 30;
            }
            if (document.getElementById('consolidatePreventions')) {
                document.getElementById('consolidatePreventions').checked = settings.consolidatePreventions !== false;
            }
            updateConsolidationStatus();
        }

        // Save settings
        function saveSettings() {
            settings.numMatches = parseInt(document.getElementById('numMatches').value);
            settings.minConfidence = parseInt(document.getElementById('minConfidence').value);
            settings.consolidatePreventions = document.getElementById('consolidatePreventions').checked;
            localStorage.setItem('anxietySettings', JSON.stringify(settings));
            updateConsolidationStatus();
            showStatus('Settings saved', 'success');
        }

        // Update consolidation status display
        function updateConsolidationStatus() {
            const statusDiv = document.getElementById('consolidationStatus');
            const statusText = document.getElementById('consolidationText');
            
            if (!statusDiv || !statusText) return;
            
            if (settings.consolidatePreventions && apiKey) {
                statusDiv.style.background = '#e8f5e9';
                statusText.innerHTML = '✅ Enabled - Will create personalized responses for multiple matches';
            } else if (settings.consolidatePreventions && !apiKey) {
                statusDiv.style.background = '#fff3e0';
                statusText.innerHTML = '⚠️ Enabled but requires API key - Add key to activate';
            } else {
                statusDiv.style.background = '#f5f5f5';
                statusText.innerHTML = '❌ Disabled - Will use standard concatenation for multiple matches';
            }
        }

        // Load API key
        function loadApiKey() {
            const savedKey = localStorage.getItem('openai_api_key');
            if (savedKey) {
                apiKey = savedKey;
                document.getElementById('apiKey').value = maskApiKey(savedKey);
                document.getElementById('apiStatus').className = 'api-status connected';
                document.getElementById('apiStatus').textContent = 'Connected';
                document.getElementById('currentKeyStatus').textContent = maskApiKey(savedKey);
                if (document.getElementById('apiWarning')) {
                    document.getElementById('apiWarning').style.display = 'none';
                }
            } else {
                if (document.getElementById('apiWarning')) {
                    document.getElementById('apiWarning').style.display = 'block';
                }
            }
            updateConsolidationStatus();
        }

        // Mask API key for display
        function maskApiKey(key) {
            if (!key) return 'Not set';
            return key.substring(0, 7) + '...' + key.substring(key.length - 4);
        }

        // Save API key
        function saveApiKey() {
            const keyInput = document.getElementById('apiKey').value.trim();
            if (keyInput && keyInput.startsWith('sk-')) {
                apiKey = keyInput;
                localStorage.setItem('openai_api_key', keyInput);
                document.getElementById('apiStatus').className = 'api-status connected';
                document.getElementById('apiStatus').textContent = 'Connected';
                document.getElementById('currentKeyStatus').textContent = maskApiKey(keyInput);
                if (document.getElementById('apiWarning')) {
                    document.getElementById('apiWarning').style.display = 'none';
                }
                showStatus('API key saved successfully!', 'success');
                document.getElementById('apiKey').value = maskApiKey(keyInput);
                updateConsolidationStatus();
            } else {
                showStatus('Please enter a valid OpenAI API key (starts with sk-)', 'error');
            }
        }

        // Test API key
        async function testApiKey() {
            if (!apiKey) {
                showStatus('Please enter and save an API key first', 'error');
                return;
            }

            showStatus('Testing API connection...', 'info');
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a test. Reply with "OK"'
                            },
                            {
                                role: 'user',
                                content: 'Test'
                            }
                        ],
                        max_tokens: 10,
                        temperature: 0
                    })
                });

                if (response.ok) {
                    showStatus('API connection successful!', 'success');
                    document.getElementById('apiStatus').className = 'api-status connected';
                    document.getElementById('apiStatus').textContent = 'Connected';
                } else {
                    const error = await response.json();
                    showStatus(`API error: ${error.error?.message || 'Unknown error'}`, 'error');
                    document.getElementById('apiStatus').className = 'api-status disconnected';
                    document.getElementById('apiStatus').textContent = 'Error';
                }
            } catch (error) {
                showStatus('Failed to connect to OpenAI API', 'error');
                document.getElementById('apiStatus').className = 'api-status disconnected';
                document.getElementById('apiStatus').textContent = 'Error';
            }
        }

        // Clear API key
        function clearApiKey() {
            if (confirm('Are you sure you want to clear your API key?')) {
                apiKey = '';
                localStorage.removeItem('openai_api_key');
                document.getElementById('apiKey').value = '';
                document.getElementById('apiStatus').className = 'api-status disconnected';
                document.getElementById('apiStatus').textContent = 'Not Connected';
                document.getElementById('currentKeyStatus').textContent = 'Not set';
                if (document.getElementById('apiWarning')) {
                    document.getElementById('apiWarning').style.display = 'block';
                }
                showStatus('API key cleared', 'info');
                updateConsolidationStatus();
            }
        }

        // GPT-based symptom matching
        async function gptSymptomMatch(userInput) {
            if (!apiKey) {
                showStatus('Please configure your OpenAI API key first', 'error');
                return enhancedKeywordSearch(userInput);
            }

            try {
                showStatus('Analyzing with GPT-3.5...', 'info');
                
                const symptomList = anxietyDatabase.map((item, index) => 
                    `${index}: ${item.symptom}`
                ).join('\n');

                const numMatches = settings.numMatches || 3;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: `You are a medical symptom matcher for anxiety symptoms. Given a user's description, match it to the ${numMatches} most appropriate symptoms from the list.

Available symptoms:
${symptomList}

Respond in JSON format with exactly ${numMatches} matches:
{
    "matches": [
        ${Array(numMatches).fill(0).map(() => `{
            "matched_index": <number>,
            "confidence": <0-100>,
            "reasoning": "<brief explanation>"
        }`).join(',\n        ')}
    ]
}`
                            },
                            {
                                role: 'user',
                                content: `Match this symptom description: "${userInput}"`
                            }
                        ],
                        temperature: 0.3,
                        max_tokens: 300
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    showStatus(`API error: ${error.error?.message || 'Unknown error'}`, 'error');
                    return enhancedKeywordSearch(userInput);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                try {
                    const result = JSON.parse(content);
                    const matches = [];
                    
                    if (result.matches && Array.isArray(result.matches)) {
                        result.matches.forEach(match => {
                            const matchedItem = anxietyDatabase[match.matched_index];
                            if (matchedItem) {
                                matches.push({
                                    item: matchedItem,
                                    score: match.confidence / 100,
                                    reasoning: match.reasoning
                                });
                            }
                        });
                    }
                    
                    if (matches.length > 0) {
                        return matches;
                    }
                } catch (parseError) {
                    console.error('Failed to parse GPT response:', parseError);
                }
                
                return enhancedKeywordSearch(userInput);
                
            } catch (error) {
                console.error('GPT matching error:', error);
                showStatus('GPT matching failed, using keyword search', 'error');
                return enhancedKeywordSearch(userInput);
            }
        }

        // Enhanced keyword search
        function enhancedKeywordSearch(userInput) {
            const userWords = userInput.toLowerCase().split(/\s+/);
            const results = [];
            
            anxietyDatabase.forEach(item => {
                let score = 0;
                const symptomWords = item.symptom.toLowerCase().split(/\s+/);
                const allKeywords = item.keywords.map(k => k.toLowerCase());
                
                userWords.forEach(userWord => {
                    if (symptomWords.some(sw => sw.includes(userWord) || userWord.includes(sw))) {
                        score += 2;
                    }
                    
                    allKeywords.forEach(kw => {
                        if (kw === userWord) {
                            score += 5;
                        } else if (kw.includes(userWord) || userWord.includes(kw)) {
                            score += 3;
                        }
                    });
                });
                
                const userLower = userInput.toLowerCase();
                item.keywords.forEach(keyword => {
                    if (userLower.includes(keyword.toLowerCase())) {
                        score += 4;
                    }
                });
                
                if (score > 0) {
                    results.push({
                        item: item,
                        score: score / Math.max(userWords.length * 3, 1)
                    });
                }
            });
            
            results.sort((a, b) => b.score - a.score);
            return results.slice(0, settings.numMatches || 3);
        }

        // Basic search
        function basicSearch(userInput) {
            const results = [];
            
            anxietyDatabase.forEach(item => {
                const score = calculateSimilarity(userInput, item.symptom);
                if (score > 0) {
                    results.push({
                        item: item,
                        score: score
                    });
                }
            });
            
            results.sort((a, b) => b.score - a.score);
            return results.slice(0, settings.numMatches || 3);
        }

        // Calculate similarity
        function calculateSimilarity(str1, str2) {
            const words1 = str1.toLowerCase().split(/\s+/);
            const words2 = str2.toLowerCase().split(/\s+/);
            
            let matches = 0;
            words1.forEach(word1 => {
                words2.forEach(word2 => {
                    if (word1.includes(word2) || word2.includes(word1)) {
                        matches++;
                    }
                });
            });
            
            return matches / Math.max(words1.length, words2.length);
        }

        // Process symptoms
        async function processSymptoms(userInput) {
            const searchMethod = document.querySelector('input[name="searchMethod"]:checked').value;
            let results = [];
            
            showStatus(`Processing with ${searchMethod} search...`, 'info');
            
            switch(searchMethod) {
                case 'gpt':
                    results = await gptSymptomMatch(userInput);
                    break;
                case 'enhanced':
                    results = enhancedKeywordSearch(userInput);
                    break;
                case 'basic':
                    results = basicSearch(userInput);
                    break;
            }
            
            const minConfidence = (settings.minConfidence || 30) / 100;
            const significantMatches = results.filter(r => r.score >= minConfidence);
            
            console.log(`Found ${significantMatches.length} significant matches`);
            
            if (significantMatches.length > 0) {
                let combinedMatch = {
                    item: {
                        symptom: '',
                        prevention: '',
                        nlpConflict: ''
                    },
                    score: 0,
                    reasoning: '',
                    isMultiple: significantMatches.length > 1,
                    wasConsolidated: false
                };
                
                combinedMatch.item.symptom = significantMatches.map(m => m.item.symptom).join(' / ');
                combinedMatch.item.nlpConflict = significantMatches.map(m => m.item.nlpConflict).join(' and ');
                
                // CONSOLIDATION LOGIC HERE
                if (searchMethod === 'gpt' && significantMatches.length > 1 && settings.consolidatePreventions && apiKey) {
                    console.log('Attempting AI consolidation...');
                    const consolidationResult = await consolidatePreventions(significantMatches, userInput);
                    combinedMatch.item.prevention = consolidationResult.text;
                    combinedMatch.wasConsolidated = consolidationResult.isConsolidated;
                    console.log('Consolidation result:', consolidationResult.isConsolidated);
                } else {
                    combinedMatch.item.prevention = significantMatches.map(m => m.item.prevention)
                        .join(' Alternatively, ');
                    combinedMatch.wasConsolidated = false;
                }
                
                const reasonings = significantMatches
                    .filter(m => m.reasoning)
                    .map((m, i) => `Match ${i+1}: ${m.reasoning}`);
                if (reasonings.length > 0) {
                    combinedMatch.reasoning = reasonings.join(' ');
                }
                
                combinedMatch.score = significantMatches.reduce((sum, m) => sum + m.score, 0) / significantMatches.length;
                combinedMatch.matches = significantMatches;
                
                displayResult(combinedMatch, userInput);
                saveToHistory(userInput, combinedMatch);
                speakPrevention(combinedMatch.item.prevention);
            } else {
                showStatus('No matching symptoms found. Try describing your symptoms differently.', 'error');
                document.getElementById('resultSection').style.display = 'none';
            }
        }

        // Display results
        function displayResult(match, userInput) {
            console.log('Displaying result. Was consolidated:', match.wasConsolidated);
            document.getElementById('resultSection').style.display = 'block';
            
            const isMultiple = match.isMultiple || match.item.symptom.includes(' / ');
            const indicator = document.getElementById('matchIndicator');
            
            if (match.wasConsolidated === true) {
                indicator.innerHTML = '🤖 AI-Consolidated Response';
                indicator.style.display = 'inline-block';
                indicator.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
            } else if (isMultiple && match.matches) {
                indicator.textContent = `${match.matches.length} Matches Found`;
                indicator.style.display = 'inline-block';
                indicator.style.background = '#667eea';
            } else {
                indicator.style.display = 'none';
            }
            
            if (match.matches && match.matches.length > 1) {
                const symptomHtml = match.matches.map((m, i) => {
                    const confidence = Math.round(m.score * 100);
                    const label = i === 0 ? 'Primary' : `Match ${i + 1}`;
                    return `<div style="margin: 5px 0;">
                        <strong style="color: #667eea;">${label} (${confidence}%):</strong> ${m.item.symptom}
                    </div>`;
                }).join('');
                document.getElementById('matchedSymptom').innerHTML = symptomHtml;
            } else {
                document.getElementById('matchedSymptom').textContent = match.item.symptom;
            }
            
            const confidence = Math.min(Math.round(match.score * 100), 100);
            document.getElementById('confidenceScore').textContent = confidence + '%';
            document.getElementById('confidenceFill').style.width = confidence + '%';
            
            if (match.reasoning) {
                document.getElementById('aiReasoning').style.display = 'block';
                document.getElementById('reasoningText').textContent = match.reasoning;
            } else {
                document.getElementById('aiReasoning').style.display = 'none';
            }
            
            document.getElementById('nlpConflict').innerHTML = match.item.nlpConflict;
            
            const preventionDiv = document.getElementById('preventionText');
            
            if (match.wasConsolidated === true) {
                console.log('Showing AI-consolidated prevention');
                preventionDiv.innerHTML = `
                    <div style="background: linear-gradient(135deg, #f0f4ff, #fff); padding: 20px; border-radius: 8px; border-left: 4px solid #667eea;">
                        <div style="font-size: 12px; color: #667eea; margin-bottom: 15px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">
                            🤖 AI-PERSONALIZED PREVENTION PLAN
                        </div>
                        <div style="color: #333; line-height: 1.8;">
                            ${match.item.prevention.split('\n\n')
                                .map(p => `<p style="margin: 12px 0;">${p.trim()}</p>`)
                                .join('')}
                        </div>
                    </div>
                `;
            } else {
                preventionDiv.innerHTML = `<div style="padding: 10px;">
                    ${match.item.prevention
                        .replace(/Alternatively,/g, '<br><br><strong style="color: #667eea;">Alternatively:</strong>')
                        .replace(/Practice/g, '<strong>Practice</strong>')
                        .replace(/Consider/g, '<strong>Consider</strong>')
                        .replace(/Use/g, '<strong>Use</strong>')}
                </div>`;
            }
            
            showStatus(match.wasConsolidated ? 
                '🎉 AI created a personalized prevention plan!' : 
                'Match found! Reading prevention technique...', 'success');
        }

        // Test consolidation
        async function testConsolidation() {
            console.log('=== TEST CONSOLIDATION ===');
            
            if (!apiKey) {
                alert('Please add your OpenAI API key first!');
                return;
            }
            
            settings.consolidatePreventions = true;
            document.getElementById('consolidatePreventions').checked = true;
            saveSettings();
            
            document.querySelector('input[value="gpt"]').checked = true;
            
            if (settings.numMatches < 2) {
                settings.numMatches = 3;
                document.getElementById('numMatches').value = 3;
                saveSettings();
            }
            
            const testInput = "I feel breathless, my heart is racing, and I feel panicky";
            document.getElementById('transcript').innerHTML = 
                `<p><strong>Test Input:</strong> ${testInput}</p>`;
            
            console.log('Processing test input...');
            await processSymptoms(testInput);
        }

        // Save to history
        function saveToHistory(userInput, match) {
            let history = JSON.parse(localStorage.getItem('anxietyHistory') || '[]');
            
            const confidence = Math.min(Math.round(match.score * 100), 100);
            const entry = {
                date: new Date().toISOString(),
                userInput: userInput,
                matchedSymptom: match.item.symptom,
                prevention: match.item.prevention,
                nlpConflict: match.item.nlpConflict,
                confidence: confidence,
                searchMethod: document.querySelector('input[name="searchMethod"]:checked').value,
                reasoning: match.reasoning || null,
                numMatches: match.matches ? match.matches.length : 1,
                consolidated: match.wasConsolidated || false
            };
            
            history.unshift(entry);
            if (history.length > 50) history = history.slice(0, 50);
            
            localStorage.setItem('anxietyHistory', JSON.stringify(history));
            loadHistory();
        }

        // Load history
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('anxietyHistory') || '[]');
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = '<p style="color: #999;">No history yet. Start by recording your symptoms.</p>';
                return;
            }
            
            historyList.innerHTML = history.map(entry => {
                const date = new Date(entry.date);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                
                const consolidationBadge = entry.consolidated ? 
                    '<span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-left: 5px;">🤖 AI Consolidated</span>' : '';
                
                return `
                    <div class="history-item">
                        <div class="date">${dateStr} ${consolidationBadge}</div>
                        <div class="symptom">Your input: ${entry.userInput}</div>
                        <div class="symptom">Matched: ${entry.matchedSymptom}</div>
                        <div style="color: #666; font-size: 14px; margin-top: 5px;">
                            Confidence: ${entry.confidence || 'N/A'}% | 
                            Method: ${entry.searchMethod || 'basic'} | 
                            Matches: ${entry.numMatches || 1}
                        </div>
                        <div style="color: #666; font-size: 13px; margin-top: 3px;">
                            NLP Conflict: ${entry.nlpConflict}
                        </div>
                        ${entry.reasoning ? `<div style="color: #555; font-size: 13px; margin-top: 5px; font-style: italic;">
                            AI Reasoning: ${entry.reasoning}
                        </div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Clear history
        function clearHistory() {
            if (confirm('Are you sure you want to clear all history?')) {
                localStorage.removeItem('anxietyHistory');
                loadHistory();
                showStatus('History cleared', 'success');
            }
        }

        // Export/Import history
        function exportHistory() {
            const history = localStorage.getItem('anxietyHistory') || '[]';
            const blob = new Blob([history], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'anxiety_history_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
            showStatus('History exported', 'success');
        }

        function importHistory() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        localStorage.setItem('anxietyHistory', JSON.stringify(data));
                        loadHistory();
                        showStatus('History imported successfully', 'success');
                    } catch (error) {
                        showStatus('Invalid history file', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Load database
        function loadDatabase() {
            const tbody = document.getElementById('databaseBody');
            tbody.innerHTML = anxietyDatabase.map(item => `
                <tr>
                    <td>${item.symptom}</td>
                    <td>${item.prevention}</td>
                    <td>${item.nlpConflict}</td>
                    <td><button class="speak-btn" onclick="speakPrevention('${item.prevention.replace(/'/g, "\\'")}')">🔊 Speak</button></td>
                </tr>
            `).join('');
        }

        // Switch tabs
        function switchTab(event, tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status-message ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Speech recognition functions
        async function checkPermissions() {
            try {
                if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                    showStatus('Your browser does not support speech recognition. Please use Chrome or Edge.', 'error');
                    document.getElementById('permissionCard').style.display = 'block';
                    document.getElementById('micButton').disabled = true;
                    return false;
                }

                if (!('speechSynthesis' in window)) {
                    showStatus('Text-to-speech not supported in your browser', 'error');
                    return false;
                }

                return true;
            } catch (error) {
                console.error('Permission check error:', error);
                return false;
            }
        }

        async function requestPermissions() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                
                initSpeechRecognition();
                document.getElementById('permissionCard').style.display = 'none';
                hasPermissions = true;
                document.getElementById('status').textContent = 'Click microphone to start';
                showStatus('Permissions granted! You can now use voice input.', 'success');
                
            } catch (error) {
                console.error('Permission error:', error);
                if (error.name === 'NotAllowedError') {
                    showStatus('Microphone access denied. Please enable it in your browser settings.', 'error');
                } else {
                    showStatus('Error accessing microphone: ' + error.message, 'error');
                }
            }
        }

        function initSpeechRecognition() {
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;

                recognition.onstart = function() {
                    isRecording = true;
                    document.getElementById('micButton').classList.add('listening');
                    document.getElementById('micIcon').textContent = '🔴';
                    document.getElementById('status').textContent = 'Listening... Speak now';
                    showStatus('Listening... Describe your symptoms', 'info');
                };

                recognition.onresult = function(event) {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript = transcript;
                        }
                    }
                    
                    if (interimTranscript) {
                        document.getElementById('transcript').innerHTML = 
                            `<p><strong>Listening:</strong> ${interimTranscript}</p>`;
                    }
                    
                    if (finalTranscript) {
                        document.getElementById('transcript').innerHTML = 
                            `<p><strong>You said:</strong> ${finalTranscript}</p>`;
                        processSymptoms(finalTranscript);
                    }
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    stopRecording();
                    
                    if (event.error === 'not-allowed') {
                        document.getElementById('permissionCard').style.display = 'block';
                    } else if (event.error === 'no-speech') {
                        showStatus('No speech detected. Please try again.', 'error');
                    } else {
                        showStatus('Error: ' + event.error, 'error');
                    }
                };

                recognition.onend = function() {
                    stopRecording();
                };

                hasPermissions = true;
                document.getElementById('status').textContent = 'Click microphone to start';

            } catch (error) {
                console.error('Failed to initialize speech recognition:', error);
                showStatus('Failed to initialize speech recognition', 'error');
            }
        }

        async function startRecording() {
            if (!hasPermissions) {
                await requestPermissions();
                return;
            }

            if (!recognition) {
                showStatus('Speech recognition not initialized. Please refresh the page.', 'error');
                return;
            }

            if (isRecording) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('Failed to start recording:', error);
                    showStatus('Failed to start recording. Please try again.', 'error');
                }
            }
        }

        function stopRecording() {
            isRecording = false;
            document.getElementById('micButton').classList.remove('listening');
            document.getElementById('micIcon').textContent = '🎤';
            document.getElementById('status').textContent = 'Click microphone to start';
        }

        function speakPrevention(text) {
            if (synthesis.speaking) {
                synthesis.cancel();
            }
            
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 1;
                
                utterance.onerror = function(event) {
                    console.error('Speech synthesis error:', event);
                    showStatus('Could not read aloud. Check your speaker settings.', 'error');
                };
                
                synthesis.speak(utterance);
            }, 100);
        }

        // Initialize app
        window.onload = async function() {
            console.log('🚀 Anxiety Helper with AI Consolidation');
            console.log('✅ consolidatePreventions function exists');
            console.log('📝 To test: Add API key, then click "Test AI Consolidation"');
            
            loadSettings();
            loadApiKey();
            loadHistory();
            loadDatabase();
            
            const canUseSpeech = await checkPermissions();
            if (canUseSpeech) {
                initSpeechRecognition();
            } else {
                document.getElementById('permissionCard').style.display = 'block';
            }
        };
    </script>
</body>
</html>
